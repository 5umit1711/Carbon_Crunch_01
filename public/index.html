<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carbon Crunch — Ingest UI</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4; --success:#10b981; --danger:#ef4444;
      --radius:10px; --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%; margin:0; background:
      radial-gradient(ellipse at 10% 10%, rgba(6,182,212,0.06), transparent 10%),
      linear-gradient(180deg,#071028 0%, #071427 100%);
      color:#e6eef6;}
    .wrap{max-width:1000px;margin:36px auto;padding:28px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6);}
    header{display:flex;align-items:center;gap:16px;margin-bottom:16px}
    header h1{font-size:20px;margin:0}
    header p{margin:0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:var(--card);padding:14px;border-radius:var(--radius);backdrop-filter: blur(6px);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    textarea#raw{width:100%;min-height:180px;border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:inherit;resize:vertical;font-family:monospace;font-size:13px}
    .controls{display:flex;gap:8px;align-items:center;margin-top:10px}
    button{background:linear-gradient(90deg,var(--accent),#3b82f6);border:none;color:#021024;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
    .sim{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:14px}
    .out{margin-top:12px;padding:10px;border-radius:8px;background:rgba(2,6,23,0.5);height:220px;overflow:auto;font-family:monospace;font-size:13px}
    .small{font-size:13px;color:var(--muted)}
    .stats{display:flex;flex-direction:column;gap:10px}
    .stat{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .stat h3{margin:0;font-size:14px}
    .stat p{margin:0;color:var(--muted)}
    footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:right}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Carbon Crunch — Manual Event Submit</h1>
        <p>Send raw events, simulate failures, and view aggregates.</p>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <label for="raw">Raw JSON event</label>
        <textarea id="raw">{"source":"client_A","payload":{"metric":"value","amount":"1200","timestamp":"2024/01/01"}}</textarea>

        <div class="controls">
          <label class="sim"><input type="checkbox" id="fail"> <span style="margin-left:6px">Simulate failure</span></label>
          <button id="send">Send Event</button>
          <button class="secondary" id="clear">Clear</button>
          <button class="secondary" id="pretty">Pretty JSON</button>
        </div>

        <div class="small" style="margin-top:10px">Response / Console</div>
        <pre id="out" class="out">Responses will appear here.</pre>
      </section>

      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0;font-size:16px">Aggregates</h2>
          <div class="small">Filter & refresh</div>
        </div>

        <div style="margin-top:10px">
          <label>Client filter</label>
          <input id="client" placeholder="client_A or leave empty" style="width:100%;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;">
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="from" type="date" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;">
          <input id="to" type="date" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;">
        </div>

        <div class="controls" style="margin-top:10px">
          <button id="agg">Fetch Aggregates</button>
          <button class="secondary" id="list">List Events</button>
        </div>

        <div class="stats" id="stats" style="margin-top:12px">
          <div class="stat"><h3>Total Events</h3><p id="total">—</p></div>
          <div class="stat"><h3>Total Amount</h3><p id="amount">—</p></div>
          <div class="stat"><h3>Clients</h3><p id="clients">—</p></div>
        </div>

        <footer>Local queue: <span id="queueStatus">OK</span></footer>
      </aside>
    </div>
  </div>

  <script>
    const out = document.getElementById('out');
    const rawEl = document.getElementById('raw');
    const failEl = document.getElementById('fail');
    const clientEl = document.getElementById('client');
    const fromEl = document.getElementById('from');
    const toEl = document.getElementById('to');

    function writeOut(obj){
      out.textContent = JSON.stringify(obj, null, 2);
    }

    document.getElementById('send').addEventListener('click', async () => {
      out.textContent = 'Sending...';
      let raw;
      try { raw = JSON.parse(rawEl.value); } catch(e){ writeOut({ error: 'Invalid JSON', details: e.message }); return; }
      const fail = failEl.checked ? '?fail=true' : '';
      try {
        const res = await fetch('/ingest' + fail, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(raw)
        });
        const body = await res.json().catch(()=>null);
        writeOut({ status: res.status, body });
      } catch (err) {
        writeOut({ network: err.message });
      }
    });

    document.getElementById('agg').addEventListener('click', async () => {
      out.textContent = 'Loading aggregates...';
      const q = new URLSearchParams();
      if (clientEl.value) q.set('client', clientEl.value);
      if (fromEl.value) q.set('from', fromEl.value);
      if (toEl.value) q.set('to', toEl.value);
      try {
        const res = await fetch('/aggregate?' + q.toString());
        const json = await res.json();
        writeOut(json);
        let total = 0, amount = 0, clients = json.length;
        json.forEach(r=>{ total += (r.count||0); amount += (r.totalAmount||0) });
        document.getElementById('total').textContent = total;
        document.getElementById('amount').textContent = amount;
        document.getElementById('clients').textContent = clients;
      } catch (err) {
        writeOut({ error: err.message });
      }
    });

    document.getElementById('clear').addEventListener('click', ()=>{ rawEl.value = ''; out.textContent = ''; });
    document.getElementById('pretty').addEventListener('click', ()=>{
      try { const j = JSON.parse(rawEl.value); rawEl.value = JSON.stringify(j, null, 2); } catch(e){ writeOut({ error: 'Invalid JSON' }) }
    });

    document.getElementById('list').addEventListener('click', async ()=>{
      out.textContent = 'Loading events...';
      try {
        const res = await fetch('/events'); 
        const json = await res.json();
        writeOut(json);
      } catch (err) {
        writeOut({ error: 'events endpoint unavailable', detail: err.message });
      }
    });

    (async function ping(){
      try {
        const res = await fetch('/', { method:'HEAD' });
        document.getElementById('queueStatus').textContent = res.ok ? 'OK' : 'Unknown';
      } catch(e){ document.getElementById('queueStatus').textContent = 'Disconnected' }
    })();
  </script>
</body>
</html>